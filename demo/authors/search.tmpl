<!DOCTYPE html>
<html>
<head>
    <title>dsws search results</title>
    <link href='https://fonts.googleapis.com/css?family=Open+Sans' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="/css/site.css">
    <style>
    .hide {
        display: none;
    }
    ul {
        list-style: disc;
    }

    .result:nth-child(odd) {
        background-color: lightgrey;
    }
    </style>
</head>
<body>
<header><h1>search results</h1></header>
<nav>
<ul>
    <li><a href="/">Home</a></li>
</ul>
</nav>

<section>
<!-- 
Request:
{{ stringify .request true }}

Status:
{{ stringify .status false }}

Total Hits: {{ .total_hits }}
Page: {{ .request.from }}
Size: {{ .request.size }}

-->

<form class="search-form" method="get" action="/api">
<!-- BEGIN: Pager -->

{{$qryTerms := (dotpath ".query.query" .request "")}}
{{$highlight :=  (has_dotpath ".highlight.style" .request "true" "false")}} 
{{$from := (int .request.from)}}
{{$size := (int .request.size)}}
{{$total := (int .total_hits)}}
{{$prev := (previ $from $size 0 $total false)}}
{{$next := (nexti $from $size 0 $total false)}}
{{$sortBy := (join .request.sort ",")}}
{{$fields := (join (dotpath ".fields" .request "*") ",")}}

<pre>
DEBUG: 
    + .request.from {{.request.from}} {{typeof .request.from}}
    + .request.size {{.request.size}} {{typeof .request.size}}
    + From: {{$from}} {{typeof $from}}
    + Size: {{$size}} {{typeof $size}}
    + Next: {{$next}} {{typeof $next}}
    + Prev: {{$prev}} {{typeof $prev}}
    + Total: {{$total}} {{typeof $total}}
    + Sort By: {{$sortBy}} {{typeof $sortBy}}
    + Fields: {{$fields}} {{typeof $fields}}
</pre>

{{if (and (gt $from 0) (ge $prev 0))}}
<a href="/api?fields={{$fields}}&highlight={{$highlight}}&from={{$prev}}&size={{$size}}&sort={{$sortBy}}&q={{$qryTerms}}">Prev</a>
{{else}}
    {{if (gt $from 0)}}
<a href="/api?fields={{$fields}}&highlight={{$highlight}}&from=0&size={{$size}}&sort={{$sortBy}}&q={{$qryTerms}}">Prev</a>
    {{end}}
{{end}}
{{(add $from 1)}} to {{if (lt $next $total)}}{{$next}}{{else}}{{$total}}{{end}}, of {{.total_hits}} records
{{if (lt $prev $total)}}
<a href="/api?fields={{$fields}}&highlight={{$highlight}}&from={{$next}}&size={{$size}}&sort={{$sortBy}}&q={{$qryTerms}}">Next</a>
{{end}}
<!-- END: Pager -->

    {{with .request}}
        <input type="hidden" name="highlight" value="true">
        {{ with .start -}}
        <input type="hidden" name="start" value="{{- . -}}">
        {{- end }}
        {{ with .fields -}}
        <input type="hidden" name="fields" value="{{- join . "," -}}">
        {{- else -}}
        <input type="hidden" name="fields" value="id,title,authors_id,authors_family,authors_given,orcid">
        {{- end }}
    {{else}}
        <input type="hidden" name="fields" value="id,title,authors_id,authors_family,authors_given,orcid">
    {{end}}
    <div><label>Search</label><input type="text" name="q" {{- with .request.query.query }} value="{{- . -}}" {{- end }} placeholder="Enter your query terms here" /></div>
<div>
     <select name="sort">
        {{with $sortBy := (join .request.sort ",") -}}
            {{if (or (eq $sortBy "-_score") (eq $sortBy ""))}}
         <option value="" selected>Relevance</option>
            {{else}}
         <option value="">Relevance</option>
            {{end}}
            {{if eq $sortBy "title"}}
        <option value="title" selected>Title</option>
            {{else}}
        <option value="title">Title</option>
            {{end}}
            {{if eq $sortBy "authors_family"}} 
        <option value="authors_family" selected>Name</option>
            {{else}}
        <option value="authors_family">Name</option>
            {{end}}
            {{if eq $sortBy "date,date_type"}}
        <option value="date,date_type" selected>Date</option>
            {{else}}
        <option value="date,date_type">Date</option>
            {{end}}
        {{- end }}
     </select>
</div>
<div>
    <select name="size">
        {{range $i := (ints 3 30 3)}}
            {{if (eq $i $size) -}}
        <option value="{{$i}}" selected>{{$i}}</option>
            {{- else -}}
        <option value="{{$i}}">{{$i}}</option>
            {{- end -}}
        {{- end}}
    </select>
</div>

    <div><input type="submit" value="Go" ></div>
</form>

<section class="search-results">
{{ range .hits }}
<div class="result">
    {{with .fields}}
        {{with .title}}<div class="title"><label class="hide">Title</label><h2 class="title">{{ . }}</h2></div>{{- end }}
        {{with .eprint_id}}<div class="eprint-id"><label>Eprint ID</label> <span class="eprint-id">{{- . -}}</span></div>{{- end }}
        {{with .abstract}}<div class="abstract"><label>Abstract:<label> <p>{{ . }}</p></div>{{- end }}
        {{ $familyName := .authors_family -}}
        {{ $givenName := .authors_given -}}
        {{ $orcid := .orcid}}
        {{ $lastAuthor := (subi (len .authors_id) 1) -}}
        {{ $official_url := .official_url -}}
        {{if (gt (len .authors_id) 0) -}}<div class="authors"><label>Authors ({{- (len .authors_id) -}})</label>
        <ul>
        {{ range $i := (ints 0 $lastAuthor 1) -}}
            <li>
             {{(index $familyName $i)}}, {{index $givenName $i}} 
             {{- with (index $orcid $i) -}}(ORCID: <a href="http://orcid.org/{{- . -}}">{{- . -}}</a>){{- end }}
            </li>
        {{- end}}
        </ul>
        {{if (eq .date_type "published")}}
            <div class="publication-date"><label>Published</label><span class="date">{{.date}}</span></div>
        {{end}}
        {{with .publication}}
            Publication: {{.}}<br />
        {{end}}
        {{with .number}}
            <div class="number"><label>Number</label><span class="number">{{- . -}}</span></div>
        {{end}}
        {{with .issn}}
            <div class="issn"><label>ISSN</label><span class="issn">{{- . -}}</span></div>
        {{end}}
        {{with .citation}}
            <div class="citation"><label>Citation</label><span class="citation">{{- . -}}</span></div>
        {{end}}
        {{with .keywords}}
            <div class="keywords"><label>Keywords</label><span class="keywords">{{- . -}}</span></div>
        {{end}}
        {{with .referencetext}}
            <div class="referencetext"><label>Reference Texts</label><span class="referencetext">{{- . -}}</span></div>
        {{end}}
    {{end}}
        {{if (eq $highlight "true")}}

        <ul>
            {{range $k,$v := .fragments}}
                <li>Matched ({{- $k -}}): {{- join $v "... " -}}</li>
            {{end}}
        </ul>
        {{end}}
</div><!-- END result-row -->
        {{end}}
    <!-- 
    {{ stringify . true }}
    -->
{{ end }}
</section/><!-- END: search-results -->
</section>

<footer>
dsws is part of <a href="https://caltechlibrary.github.io/dataset">dataset</a> project.
</footer>
</body>
</html>
